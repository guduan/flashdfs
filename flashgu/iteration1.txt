#!/bin/csh -f
set nonomatch

sddsconvert -ascii flash_dfs1.mat -nowarnings
sddsconvert -ascii flash_dfs2.mat -nowarnings
sddsconvert -ascii flash_dfs3.mat -nowarnings

## only use for ORM calculation
#sddsconvert -ascii flash_dfs1.hrm -nowarnings
#sddsconvert -ascii flash_dfs2.hrm -nowarnings
#sddsconvert -ascii flash_dfs3.hrm -nowarnings

# sort Transport Matrice for Matlab loading
sddsconvert -pipe=out -ascii flash_dfs1.mat  -retain=col,s,ElementName,R* -fromPage=1 -toPage=1 \
    | sddsprintout -pipe=in -col=* -width=9999 flash_dfs1.mat1
sddsconvert -pipe=out -ascii flash_dfs2.mat  -retain=col,s,ElementName,R* -fromPage=1 -toPage=1 \
	| sddsprintout -pipe=in -col=* -width=9999 flash_dfs2.mat1
sddsconvert -pipe=out -ascii flash_dfs3.mat  -retain=col,s,ElementName,R* -fromPage=1 -toPage=1 \
	| sddsprintout -pipe=in -col=* -width=9999 flash_dfs3.mat1

# get bpm&quad positions and input error values
sddsprocess -pipe=out flash_dfs1.erl -match=col,ElementType=MONI  -match=col,ElementParameter=DX \
	| sddsprintout -pipe=in -col=ParameterValue -width=9999 flash_dfs.realbpmoffset
sddsprocess -pipe=out flash_dfs1.erl  -match=col,ElementType=QUAD -match=col,ElementParameter=DX \
	| sddsprintout -pipe=in -col=ParameterValue -width=9999 flash_dfs.realquadoffset

sddsprocess  -pipe=out flash_dfs1.cen -match=col,ElementType=MONI \
	| sddsconvert -pipe=in -ascii -retain=col,s,ElementName,ElementType,ElementOccurence -fromPage=1 -toPage=1 flash_dfs.bpmlocation
	
sddsprocess  -pipe=out flash_dfs1.cen -match=col,ElementType=QUAD\
	| sddsconvert -pipe=in -ascii -retain=col,s,ElementName,ElementType,ElementOccurence -fromPage=1 -toPage=1 flash_dfs.quadlocation

#sddsxref  flash_dfs.bpmoffset.real  flash_dfs.bpmlocation flash_dfs.bpmoffset.real1 -take=s
#sddsxref  flash_dfs.quadoffset.real  flash_dfs.quadlocation flash_dfs.quadoffset.real1 -take=s
	
# get the BPM readings @ each energy
sddsprocess -pipe=out flash_dfs1.cen -match=col,ElementType=MONI  \
	| sddsconvert -pipe=in -ascii -retain=col,s,Cx -fromPage=1 -toPage=1 flash_dfs1.cx
sddsprocess -pipe=out flash_dfs2.cen -match=col,ElementType=MONI \
	| sddsconvert -pipe=in -ascii -retain=col,s,Cx -fromPage=1 -toPage=1 flash_dfs2.cx
sddsprocess -pipe=out flash_dfs3.cen -match=col,ElementType=MONI \
	| sddsconvert -pipe=in -ascii -retain=col,s,Cx  -fromPage=1 -toPage=1 flash_dfs3.cx

sddsprintout  flash_dfs1.cx -col=Cx -width=9999 flash_dfs1.orbit
sddsprintout  flash_dfs2.cx -col=Cx -width=9999 flash_dfs2.orbit
sddsprintout  flash_dfs3.cx -col=Cx -width=9999 flash_dfs3.orbit