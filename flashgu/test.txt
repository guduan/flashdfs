#!/bin/csh -f 
set nonomatch 

./cleanup.txt >&test.log

sddsprocess undulator_quad.sdds -redefine=col,ParameterValue,"ParameterValue 100 * 50 /  " undulator_quad_600MeV.sdds
sddsprocess undulator_quad.sdds -redefine=col,ParameterValue,"ParameterValue 100 * 60 /  " undulator_quad_720MeV.sdds
sddsprocess undulator_quad.sdds -redefine=col,ParameterValue,"ParameterValue 100 * 75 /  " undulator_quad_900MeV.sdds

elegant flash_dfs01.ele >> test.log
elegant flash_dfs02.ele >> test.log
elegant flash_dfs03.ele >> test.log

if(-e flash_dfs03.cen) then
	echo "**********************"
	echo "run 3 energies DONE."
	echo "**********************"
else
	echo "Please check 'elegant flash_dfs03.ele'!"
endif

#sddsplot  \
#	-col=s,Cx flash_dfs01.cen -graph=line,type=1 -legend=spec="orbit @600MeV before correction"  \
#	-col=s,Cx flash_dfs02.cen -graph=line,type=2 -legend=spec="orbit @720MeV before correction"  \
#	-col=s,Cx flash_dfs03.cen -graph=line,type=3 -legend=spec="orbit @900MeV before correction" 

# sort Transport Matrice for Matlab loading
sddsconvert -pipe=out -ascii flash_dfs01.mat  -retain=col,s,ElementName,R* -fromPage=1 -toPage=1 \
    | sddsprintout -pipe=in -col=* -width=9999 flash_dfs01.mat1
sddsconvert -pipe=out -ascii flash_dfs02.mat  -retain=col,s,ElementName,R* -fromPage=1 -toPage=1 \
	| sddsprintout -pipe=in -col=* -width=9999 flash_dfs02.mat1
sddsconvert -pipe=out -ascii flash_dfs03.mat  -retain=col,s,ElementName,R* -fromPage=1 -toPage=1 \
	| sddsprintout -pipe=in -col=* -width=9999 flash_dfs03.mat1

if(-e flash_dfs03.cen) then
	echo "Transport Matrice preparation DONE!"
	echo "**********************"
else
	echo "Please check 'elegant flash_dfs03.ele'!"
endif

./iteration1.txt >> test.log

if(-e flash_dfs3.orbit) then
	echo "Measure Orbits DONE"
	echo "**********************"
endif


