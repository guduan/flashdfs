#!/bin/csh -f
set nonomatch

sddsprocess -pipe=out flash_dfs1.erl  -match=col,ElementParameter=DX -match=col,ElementType=QUAD \
	| sddsconvert -pipe -retain=col,ElementParameter,ElementName,ElementOccurence -delete=parameter,* \
	| sddsxref -pipe qoffset_new1.sdds -take=ParameterValue  \
	| sddsxref -pipe=in flash_dfs.quadlocation -take=s qoffset_new_after_1st.sdds

sddsprocess -pipe=out flash_dfs1.erl  -match=col,ElementParameter=DX -match=col,ElementType=MONI \
	| sddsconvert -pipe -retain=col,ElementParameter,ElementName,ElementOccurence -delete=parameter,* \
	| sddsxref -pipe bpmoffset_new1.sdds -take=ParameterValue  \
	| sddsxref -pipe=in flash_dfs.bpmlocation -take=s bpmoffset_new_after_1st.sdds

#put new quad/bpmoffset into lattice to check the orbit and dispersion
elegant flash_dfs11.ele >> test.log
elegant flash_dfs12.ele >> test.log
elegant flash_dfs13.ele >> test.log

sddsplot  \
	-col=s,Cx flash_dfs1.cen -graph=line,type=1 -legend=spec="orbit @600MeV before correction"  \
	-col=s,Cx flash_dfs2.cen -graph=line,type=2 -legend=spec="orbit @720MeV before correction"  \
	-col=s,Cx flash_dfs3.cen -graph=line,type=3 -legend=spec="orbit @900MeV before correction" 
sddsplot  \
	-col=s,Cx flash_dfs11.cen -graph=line,type=1 -legend=spec="orbit @600MeV after 1st correction"  \
	-col=s,Cx flash_dfs12.cen -graph=line,type=2 -legend=spec="orbit @720MeV after 1st correction"  \
	-col=s,Cx flash_dfs13.cen -graph=line,type=3 -legend=spec="orbit @900MeV after 1st correction" 
	
sddsplot  \
	-col=s,Cx flash_dfs1.cen  -graph=line,type=1 -legend=spec="orbit @600MeV before correction"  \
	-col=s,Cx flash_dfs11.cen  -graph=line,type=3 -legend=spec="orbit @600MeV after 1st correction"


#sddsplot -graph=line,vary \
#	-col=s,x  flash_dfs1.traj  -fromPage=1 -toPage=1 -legend=spec=orbit_before_1st_DFS \
#	-col=s,Cx test2.cen -fromPage=5 -toPage=5 -legend=spec=orbit_after_1st_DFS
#
#./measure_dispersion.txt test0 BEFORE_DFS	
#./measure_dispersion.txt test2 AFTER_1st_DFS
echo "after_iteration is DONE"