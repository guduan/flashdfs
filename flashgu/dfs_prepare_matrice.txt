#!/bin/csh -f 
set nonomatch 

./cleanup.txt 

sddsprocess undulator_quad.sdds -redefine=col,ParameterValue,"ParameterValue 10 * 9 / " undulator_quad_0.9.sdds

elegant flash_dfs.ele
elegant flash_dfs1.ele

# sort Transport Matrice for Matlab loading
sddsconvert -pipe=out -ascii flash_dfs.mat  -retain=col,s,ElementName,R* -fromPage=1 -toPage=1 \
	| sddsprintout -pipe=in -col=* -width=9999 flash_dfs.mat1
sddsconvert -pipe=out -ascii flash_dfs1.mat  -retain=col,s,ElementName,R* -fromPage=1 -toPage=1 \
	| sddsprintout -pipe=in -col=* -width=9999 flash_dfs1.mat1

# find the real Quad offsets settings(flash_dfs.erl1 should be equal to flash_dfs1.erl1)
sddsprocess -pipe=out flash_dfs.erl  -match=col,ElementParameter=DX \
	| sddsprintout -pipe=in -col=ParameterValue -width=9999 flash_dfs.erl1	
sddsprocess -pipe=out flash_dfs1.erl  -match=col,ElementParameter=DX \
	| sddsprintout -pipe=in -col=ParameterValue -width=9999 flash_dfs1.erl1	
    
# find the measured BPM readings and difference between two orbit, then output difforbit.
sddsprocess -pipe=out flash_dfs.cen -match=col,ElementType=MONI  \
	| sddsconvert -pipe=in -ascii -retain=col,s,Cx -fromPage=1 -toPage=1 flash_dfs.cx
sddsprocess -pipe=out flash_dfs1.cen -match=col,ElementType=MONI \
	| sddsconvert -pipe=in -ascii -retain=col,Cx -reName=col,Cx=Cx1 -fromPage=1 -toPage=1 flash_dfs1.cx

sddsxref -pipe=out flash_dfs.cx flash_dfs1.cx -take=Cx1 \
	| sddsprocess -pipe=in flash_dfs.twox -define=col,difforbit,"Cx Cx1 -"

sddsprintout  flash_dfs.cx -col=Cx -width=9999 flash_dfs.orbit
sddsprintout  flash_dfs1.cx -col=Cx1 -width=9999 flash_dfs1.orbit
sddsprintout  flash_dfs.twox -col=difforbit -width=9999 flash_dfs.difforbit

 sddsplot flash_dfs.twox -graph=line,vary \
	-col=s,Cx  -legend=spec=Normal_Eenrgy \
	-col=s,Cx1  -legend=spec=0.9*_NormalEenrgy \
	-col=s,difforbit  -legend=spec=difforbit

sddsprocess -pipe=out flash_dfs.erl  -match=col,ElementParameter=DX \
	| sddsconvert -pipe=in -retain=col,ElementName,ParameterValue flash_dfs.realoffset	

